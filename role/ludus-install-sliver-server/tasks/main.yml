---
- name: Gather facts if needed
  when: ansible_os_family is undefined
  ansible.builtin.setup:
  
- name: Debug Task
  when: linux_config_debug is defined
  block:
    - name: Print all available facts
      ansible.builtin.debug:
        var: ansible_facts

    - name: Debug os family
      ansible.builtin.debug:
        msg: "{{ ansible_os_family }} {{ ansible_facts['ansible_lsb']['release'] }}"

- name: Check for Linux
  when: ansible_os_family != "Debian"
  ansible.builtin.fail:
    msg: This role only supports Linux

- name: Setup Debian (sliver C2 installation)
  when: ansible_os_family == "Debian"
  block:
    - name: Update all packages to their latest version
      ansible.builtin.apt:
        name: "*"
        state: latest
        update_cache: true

    - name: Install required packages
      become: true
      ansible.builtin.apt:
        name:
          - git
          - gpg
          - gpg-agent
          - mingw-w64
          - ca-certificates
          - curl
        state: present
        autoremove: true
        clean: true
      register: result
      retries: 2
      until: result.failed == false

    - name: Download metasploit-framework installer
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb
        dest: /tmp/msfinstall
        mode: '0755'

    - name: Install metasploit nightly
      become: true
      ansible.builtin.script:
        cmd: /bin/bash /tmp/msfinstall
      args:
        chdir: /opt
        creates: /opt/metasploit-framework/bin/msfconsole

    - name: Download sliver server
      ansible.builtin.get_url:
        url: https://github.com/BishopFox/sliver/releases/download/v1.5.42/sliver-server_linux
        dest: /usr/local/bin/sliver-server
        mode: '0755'

    - name: Create a directory for sliver-server config if it does not exist
      ansible.builtin.file:
        path: /home/debian/.sliver/configs
        state: directory
        owner: debian
        group: debian
        mode: '0755'

    - name: Create custom sliver-server configuration
      ansible.builtin.copy:
        dest: /home/debian/.sliver/configs/server.json
        content: |
          \{
          "daemon_mode": false,
          "daemon": \{
          "host": "",
          "port": {{ sliver_server_port }}
          \},
          "logs": \{
          "level": 4,
          "grpc_unary_payloads": false,
          "grpc_stream_payloads": false,
          "tls_key_logger": false
          \},
          "jobs": \{
          "multiplayer": null
          \},
          "watch_tower": null,
          "go_proxy": ""
          \}
        owner: debian
        group: debian
        mode: '0644'

    - name: Create sliver-server daemon service
      become: true
      ansible.builtin.copy:
        dest: /etc/systemd/system/sliver-server.service
        content: |
          [Unit]
          Description=Sliver Server
          After=network.target
          StartLimitIntervalSec=0

          [Service]
          Type=simple
          Restart=on-failure
          RestartSec=3
          User=debian
          ExecStart=/usr/local/bin/sliver-server daemon

          [Install]
          WantedBy=multi-user.target
        owner: root
        group: root
        mode: '0644'

    - name: Reload systemd daemon
      become: true
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Enable sliver-server daemon service
      become: true
      ansible.builtin.systemd:
        name: sliver-server.service
        enabled: true
        state: started
